<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Broom Video Conferencing</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/2-col-portfolio.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Kaushan+Script' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
              <a class="navbar-brand page-scroll" href="broomsimple.herokuapp.com">Broom <i class="fa fa-paint-brush"></i></a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <!-- Page Content -->
    <div class="container">
      <div class="alert alert-info" style="overflow:hidden">
        <p class="pull-left" id="key-count"></p>
        <button class="btn btn-sm btn-default pull-right" id="resetButton">Reset Keys</button>
      </div>

        <!-- /.row -->

        <!-- Projects Row -->
        <div class="row rowOthers">
          <h3>
              <a href="#">Others</a>
          </h3>

          <div id="remotes"></div>
        </div>
        <!-- /.row -->

        <!-- Projects Row -->
        <div class="row">
          <div class = "col-lg-6">
            <div class ="panel panel-default videoOverallContainer">
            <h4 class = "panel-heading">
              ME
            </h4>

            <div class="panel-body videoContainer col-md-6 portfolio-item">
              <div id="localVideo" muted></div>

                <div id="localVolume" class="volume progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100">
                </div>

           </div>
           </div>
         </div>

        </div>
        <!-- /.row -->


        <hr>

        <!-- Footer -->
        <footer>
            <div class="row">
                <div class="col-lg-12">
                    <p>Copyright &copy; Broom 2015</p>
                </div>
            </div>
            <!-- /.row -->
        </footer>

    </div>
    <!-- /.container -->

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <script src = "https://simplewebrtc.com/latest.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
      var num = 1;
      var internalPanel;

      var webrtc = new SimpleWebRTC({
        localVideoEl: 'localVideo',
        remoteVideosEl: '',
        autoRequestMedia: true,
        url: 'https://broomsignaling.herokuapp.com'
      });

      var name = window.location.pathname.split("/")[1];
      webrtc.on('readyToCall', function(){
        if (window.location.pathname.split("/").length > 1) {
          webrtc.joinRoom(name);
          console.log("Joined room " + name);
        }
      });

      // a peer video has been added
      webrtc.on('videoAdded', function (video, peer) {
        console.log('video added', peer);
        var remotes = document.getElementById('remotes');
        if (remotes) {
          var overall = document.createElement('div');
          var panel = document.createElement('div');
          var panelHeading = document.createElement('h5');
          var panelBody = document.createElement('div');

          overall.className = "col-lg-6";
          overall.id = 'container_' + webrtc.getDomId(peer);
          panel.className = "panel panel-default videoOverallContainer";
          panelHeading.className = "panel-heading";
          panelHeading.innerHTML = "User " + num;
          panelBody.className = "panel-body videoContainer"

          // show the remote volume
          var vol = document.createElement('div');
          vol.className += "volume progress-bar progress-bar-success";
          vol.id = 'volume_' + peer.id;

        $(vol).css('width', '0%').attr('aria-valuemin', 0);
        $(vol).css('width', '0%').attr('aria-valuemax', 100);
        $(vol).css('width', '0%').attr('aria-valuenow', 10);

          panelBody.appendChild(vol);




          panelBody.appendChild(video);
          panel.appendChild(panelHeading);
          panel.appendChild(panelBody);
          overall.appendChild(panel);
          remotes.appendChild(overall);
          num+=1;



        }
      });

      webrtc.on('videoRemoved', function (video, peer) {
        console.log('video removed ', peer);
        var remotes = document.getElementById('remotes');
        var el = document.getElementById(peer ? 'container_' + webrtc.getDomId(peer) : 'localScreenContainer');
        if (remotes && el) {
          remotes.removeChild(el);
        }
        num -=1;
      });

      var keyCount = -1;



      // SOCKET IO STUFF


      var socket = io.connect("/");
      socket.emit("increase room", name);
      socket.emit('get room', name, function (err, msg) {});

      // Reset this room!
      $("#resetButton").click(function(){
        socket.emit("reset room", name);
      });

      socket.on("get room", function(msg){
        if (keyCount === -1) {
          var roomName = msg.split(":")[0];
          console.log("set room called");
          if (roomName === name) {
            console.log(msg);
            keyCount = parseInt(msg.split(":")[1]);
            document.getElementById("key-count").innerHTML = "Current Key Count: " + keyCount;
          }
        }
      });

      socket.on("reset room", function(msg){
        // This is my room
        if (msg === name) {
          console.log("Room " + msg + " told to reset");
          keyCount = 0;
          socket.emit("increase room", msg);
          document.getElementById("key-count").innerHTML = "Current Key Count: " + keyCount;
        }
      });

      socket.on("increase room", function(msg){
        if (msg === name && keyCount != -1) {
          console.log("Room " + msg + " increase");
          keyCount +=1;
          document.getElementById("key-count").innerHTML = "Current Key Count: " + keyCount;
        }
      });

      // helper function to show the volume
      function showVolume(el, volume) {
        console.log('showVolume', volume, el);
        if (!el) return;
        if (volume <0){
          volume = 100+volume;
        }
        volume -= 20;
        $(el).css('width', volume+'%').attr('aria-valuenow', volume);
      }

      webrtc.on('volumeChange', function (volume, treshold) {
            showVolume(document.getElementById('localVolume'), volume);
        });

      webrtc.on('remoteVolumeChange', function (peer, volume) {
          showVolume(document.getElementById('volume_' + peer.id), volume);
        });

   </script>
</body>

</html>
